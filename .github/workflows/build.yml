name: Build Electron App

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:  # Manual trigger

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Configure GitLab access for rs-dto
        run: |
          git config --global url."https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/".insteadOf "ssh://git@gitlab.com/"
          git config --global url."https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/".insteadOf "git@gitlab.com:"

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Make Windows distributables
        env:
          S3_ENPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_FOLDER: ${{ secrets.S3_FOLDER }}
          S3_REGION: ${{ secrets.S3_REGION }}
          APP_STORE_URL: ${{ secrets.APP_STORE_URL }}
        run: npm run make

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ github.sha }}
          path: |
            out/make/**/*.exe
            out/make/**/*.nupkg
          retention-days: 14

  build-macos:
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Configure GitLab access for rs-dto
        run: |
          git config --global url."https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/".insteadOf "ssh://git@gitlab.com/"
          git config --global url."https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/".insteadOf "git@gitlab.com:"

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Make macOS distributables
        env:
          S3_ENPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_FOLDER: ${{ secrets.S3_FOLDER }}
          S3_REGION: ${{ secrets.S3_REGION }}
          APP_STORE_URL: ${{ secrets.APP_STORE_URL }}
        run: npm run make

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ github.sha }}
          path: out/make/**/*.zip
          retention-days: 14
